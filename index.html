<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>Text LZ</title>
	<script src="https://code.jquery.com/jquery-3.1.1.slim.min.js"></script>

	<script>
		var Aaca = `aacaacabcabaaac`;
		var Alice = `Alice was beginning to get very tired of sitting by her sister on the bank, and of having nothing to do: once or twice she had peeped into the book her sister was reading, but it had no pictures or conversations in it, ‘and what is the use of a book,’ thought Alice ‘without pictures or conversations?’`;
		var Powers = "";
		for (var i = 0; i < 31; i++) {
			Powers += (1 << i) + "\n";
		}
		var Pi = `3.141592653589793238462643383279502884197169399375105820974944592307816406286208998628034825342117067982148086513282306647093844609550582231725359408128481117450284102701938521105559644622948954930381964428810975665933446128475648233786783165271201909145648566923460348610454326648213393607260249141273724587006606315588174881520920962829254091715364367892590360011330530548820466521384146951941511609433057270365759591953092186117381932611793105118548074462379962749567351885752724891227938183011949129833673362440656643086021394946395224737190702179860943702770539217176293176752384674818467669405132000568127145263560827785771342757789609173637178721468440901224953430146549585371050792279689258923542019956112129021960864034418159813629774771309960518707211349999998372978049951059731732816096318595024459455346908302642522308253344685035261931188171010003137838752886587533208381420617177669147303598253490428755468731159562863882353787593751957781857780532171226806613001927876611195909216420198`;
		var Random = "";
		for (var i = 0; i < 1000; i++) {
			var d = Math.floor (Math.pow (2, Math.random () * 3.1)) - 1;
			Random += String.fromCharCode (d + 97);
		}
		var UnicodeHi = ""
			+ "Here are some characters that take two bytes to represent:\n"
			+ "Ⅷ = U+2167, ⨌ = U+2A0C\n"
			+ "\n"
			+ "The following characters take three bytes to represent, and all share a common two-byte prefix. They range from U+28000 to U+2800F:\n"
			+ "𨀀𨀁𨀂𨀃𨀄𨀅𨀆𨀇𨀈𨀉𨀊𨀋𨀌𨀍𨀎𨀏\n"
			+ "Try UTF-8 instead of UTF-16 to lower the size of literals. Note that UTF-16 uses a surrogate pair (each end of size 2 bytes) to display a single 3-byte characters.";

		$ (function () {
			refresh ();

			$ ("#input").on ('input', refresh);
			$ ("#dictSize").change (refresh);
			$ ("#matchSize").change (refresh);
			$ ("#showBits").change (refresh);
			$ ("#encodeUtf8").change (refresh);

			$ ("#enableAdvanced").click (function () {
				$ (".advanced").toggleClass ('advanced');
				$ ("#enableAdvanced").remove ();
			});

			$ ("#setAaca").click (function () {
				$ ('#input').val (Aaca);
				refresh ();
			});
			$ ("#setAlice").click (function () {
				$ ('#input').val (Alice);
				refresh ();
			});
			$ ("#setPowers").click (function () {
				$ ('#input').val (Powers);
				refresh ();
			});
			$ ("#setPi").click (function () {
				$ ('#input').val (Pi);
				refresh ();
			});
			$ ("#setRandom").click (function () {
				$ ('#input').val (Random);
				refresh ();
			});
			$ ("#setUnicodeHi").click (function () {
				$ ('#input').val (UnicodeHi);
				refresh ();
			});

			function toUtf8 (text) {
				var utf8 = unescape (encodeURIComponent (text));
				return utf8;
			}

			function refresh () {
				var text = $ ('#input').val ();

				var showBits = $ ('#showBits').prop ('checked');
				var encodeUtf8 = $ ('#encodeUtf8').prop ('checked');

				var litRawBits;
				if (encodeUtf8) {
					text = toUtf8 (text);
					litRawBits = 8;
				} else {
					litRawBits = 16;
				}
				var litBits = litRawBits + 1;

				var dictSizeBits = parseInt ($ ('#dictSize').val ());
				var matchSizeBits = parseInt ($ ('#matchSize').val ());

				var refBits = 1 + dictSizeBits + matchSizeBits;
				var minMatchLength = Math.ceil ((refBits + 1) / litBits);

				var dictSize = 1 << dictSizeBits;
				var matchSize = matchSizeBits == 0
					? 0
					: 1 << matchSizeBits;
				matchSize += minMatchLength;

				$ ('#refSizeInfo').text (""
					+ "A reference will take "
					+ "1 + " + dictSizeBits + " + " + matchSizeBits + " = "
					+ refBits + " bits.");
				$ ('#litSizeInfo').text (""
					+ "A literal will take "
					+ "1 + " + litRawBits + " = "
					+ litBits + " bits.");

				$ ('#dictRange').text ("1 to " + dictSize);
				$ ('#matchRange').text (minMatchLength + " to " + matchSize);

				$ ('#output').empty ();

				var cursor = 0;
				while (cursor < text.length) {
					var bestOffset = 0;
					var bestLen = 0;

					for (var offset = 1; offset <= dictSize && cursor - offset >= 0; offset++) {
						var len = 0;
						while (true
						&& (cursor + len < text.length)
						&& (len < matchSize)
						&& (text[cursor - offset + len] == text[cursor + len])
							) {
							len++;
						}
						if (len > bestLen) {
							bestLen = len;
							bestOffset = offset;
						}
					}

					var add = "<div class='lzelem'>";

					if (bestLen < minMatchLength) {
						add += "<div class='lzlit'>"
							+ text[cursor]
							+ "</div>";
						if ($ ('#showBits').prop ('checked')) {
							add += "<div class='lzsubscript lzbits'>"
								+ litBits
								+ "</div>";
						}
						cursor++;
					}
					else {
						add += "<div class='lzref'>"
							+ "'" + text.substr (cursor - bestOffset, bestLen) + "'"
							+ "</div>";
						if ($ ('#showBits').prop ('checked')) {
							add += "<div class='lzsubscript lzbits'>"
								+ refBits
								+ "</div>";
						}
						add += "<div class='lzsubscript lzrefval'>"
							+ "[" + bestOffset + "," + bestLen + "]"
							+ "</div>";
						cursor += bestLen;
					}

					add += "</div>";
					$ (add).appendTo ('#output');
				}
			}
		})
		;
	</script>

	<style>
		html {
			font-size: 100%;
			font-family: sans-serif;
		}

		body {
			font-size: 150%;
		}

		.content {
			max-width: 1000px;
			margin: auto;
			text-align: center;
		}

		.advanced {
			display: none;
		}

		.button {
			border: 0.1em solid #999;
			padding: 0.3em;
			background: #ddd;
			display: inline-block;
			margin: 0.5em;
		}

		#input {
			width: 100%;
			height: 10em;
			font-size: 110%;
		}

		.lzout {
			font-family: Consolas;
		}

		.lzelem {
			display: inline-block;
			vertical-align: top;
			margin: 0.05em;
		}

		.lzlit {
			border: 0.1em solid red;
			padding: 0.05em;
		}

		.lzref {
			border: 0.1em solid blue;
			padding: 0.05em;
		}

		.lzbits {
			background: #eee;
		}

		.lzsubscript {
			font-size: 60%;
		}
	</style>
</head>

<body>

<div class="content">
	<h1>Text LZSS</h1>

	<div>
		<label for="dictSize">Bits used to store match offset (dictionary size):</label>
		<input type="number" id="dictSize" name="dictSize" style="width: 4em; font-size: 1em; text-align: center"
		       value="6" ;>
		<div>Resulting valid range: <span id="dictRange"></span></div>
		<br>

		<label for="matchSize">Bits used to store match length:</label>
		<input type="number" id="matchSize" name="matchSize" style="width: 4em; font-size: 1em; text-align: center"
		       value="4" ;>
		<div>Resulting valid range: <span id="matchRange"></span></div>
		<br>

		<div class="advanced">
			<div id="refSizeInfo"></div>
			<div id="litSizeInfo"></div>
			<label for="showBits">Show required bits</label>
			<input type="checkbox" id="showBits" name="showBits">
			<br>
			<label for="encodeUtf8">Encode literals as UTF-8 (instead of UTF-16)</label>
			<input type="checkbox" id="encodeUtf8" name="encodeUtf8" checked>
		</div>
		<br>
	</div>

	<div>
		<div>Examples:</div>
		<div class="button" id="setAaca">Aaca</div>
		<div class="button" id="setAlice">Alice in Wonderland</div>
		<div class="button" id="setPowers">Powers of 2</div>
		<div class="advanced">
			<div class="button" id="setPi">Digits of Pi</div>
			<div class="button" id="setRandom">Random</div>
			<div class="button" id="setUnicodeHi">Unicode and surrogates</div>
		</div>
	</div>

	<textarea id="input">Type here. Your text will be compressed using LZSS (a common compression algorithm).</textarea>
	<br>

	<div id="output" class="lzout"></div>
	<!-- todo: link to this result -->
	<br>

	<div class="button" id="enableAdvanced">Display some complicated and boring technical stuff</div>

	<br>
	<div>
		<h3>What is this?</h3>
		<div style="text-align: justify; line-height: 150%; margin: auto; width: 70%">
			<p>
				The text is compressed using a (crude) variant of LZSS. This basically means that any long, repeated
				character sequence gets replaced with a short reference to its previous location, thus saving space.
			</p>
			<p>
				Each element in LZSS output is either a literal or a reference.
				(In comparison, LZ77 exclusively uses references and literals combined in pairs.)
				Red boxes represent literals (uncompressed parts).
				Blue boxes contain references.
				A reference consists of an offset denoting how far to look back, and a length showing how many literals
				to copy.
				The minimum length of a reference is 3 bytes - any less would be wasteful, as references take at least
				two bytes space themselves.
			</p>
			<p>
				This variant of LZSS does not make use of Huffman trees, which would encode (among others) control codes
				and literals to represent them in just a few bits instead of a whole byte.
			</p>
		</div>
	</div>
</div>

</body>

</html>
